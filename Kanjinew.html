<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Kanji Vault - Final Attempt</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 0; color: #333; }
        header { background: #2c3e50; color: white; padding: 15px 20px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        header h1 { margin: 0; font-size: 1.8em; }
        .info-box { padding: 10px; margin: 10px 20px; background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404; border-radius: 5px; text-align: center; font-size: 0.9em;}
        .filters { padding: 15px; text-align: center; background-color: #fff; border-bottom: 1px solid #ddd; flex-wrap: wrap; display: flex; justify-content: center;}
        .filters button { margin: 5px; padding: 10px 15px; border: none; border-radius: 5px; background: #3498db; color: white; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s ease; }
        .filters button:hover { background: #2980b9; }
        .filters button.active { background: #e74c3c; }
        .filters button:disabled { background-color: #aaa; cursor: not-allowed; opacity: 0.7;}
        .status-bar { display: flex; flex-direction: column; align-items: center; gap: 5px; padding: 10px 20px; background: #ecf0f1; font-size: 0.9em; text-align: center;}
        @media (min-width: 768px) { .status-bar { flex-direction: row; justify-content: space-between; } }
        .counter-bar { font-weight: bold; }
        .kanji-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; padding: 20px; min-height: 200px; /* Ensure it's visible even when empty */ }
        .kanji-card { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; flex-direction: column; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .kanji-card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.08); }
        .kanji-char { font-size: 3.5em; color: #2c3e50; text-align: center; margin-bottom: 10px; position: relative; }
        .kanji-details div { margin-bottom: 6px; font-size: 0.85em; word-wrap: break-word; }
        .kanji-details .field-label { font-weight: bold; color: #555; }
        .learned-btn { margin-top: auto; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9; color: #333; cursor: pointer; text-align: center; font-size: 0.85em; transition: background-color 0.2s ease, color 0.2s ease; }
        .learned-btn.is-learned { background: #2ecc71; color: white; border-color: #27ae60;}
        .learned-btn:hover:not(:disabled) { background: #e9e9e9; }
        .learned-btn.is-learned:hover:not(:disabled) { background: #27ae60; }
        #pagination-controls { text-align: center; padding: 20px; }
        #pagination-controls button { margin: 0 5px; padding: 8px 15px; background-color: #3498db; color:white; border: none; border-radius: 4px; cursor: pointer; }
        #pagination-controls button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .loader { text-align: center; padding: 30px; font-size: 1.2em; color: #555;}
        .error-message { color: red; font-weight: bold; }
        .speech-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #3498db;
            padding: 0;
            line-height: 1;
            transition: color 0.2s ease;
        }
        .speech-button:hover {
            color: #2980b9;
        }
        .speech-button:disabled {
            color: #aaa;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <header><h1>Kanji Vault</h1></header>
    <div id="info-box-area"></div>
    <div class="filters">
        <button data-level="all">All Kanji</button>
        <button data-level="jlpt_n5">JLPT N5</button>
        <button data-level="jlpt_n4">JLPT N4</button>
        <button data-level="jlpt_n3">JLPT N3</button>
        <button data-level="jlpt_n2">JLPT N2</button>
        <button data-level="jlpt_n1">JLPT N1</button>
        <button data-level="jlpt_other">Other Kanji</button>
        <button data-level="learned">Learned</button>
    </div>
    <div class="status-bar">
        <div id="jlpt-counts" class="counter-bar">Loading counts...</div>
        <div id="current-view-count">Displaying: 0 Kanji</div>
    </div>
    <div id="kanji-list" class="kanji-grid">
        <div class="loader">Initializing and attempting to load core data... Please ensure 'data/all_kanji.json' exists.</div>
    </div>
    <div id="pagination-controls"></div>

    <script>
    // --- Start of Script ---
    // IMPORTANT NOTE FOR LOCAL DEVELOPMENT:
    // If Kanji are not loading and you see errors about "fetch" or "CORS policy" in the browser console (F12),
    // it's likely due to security restrictions on directly opening HTML files that try to load other local files.
    // SOLUTION: Use a simple local web server.
    //   1. Python: Navigate to this project's folder in your terminal and run `python -m http.server` (or `python3 ...`).
    //   2. Node.js: If you have Node.js, run `npx serve` in this folder.
    //   3. VS Code: The "Live Server" extension is excellent.
    // Then, access the page via `http://localhost:PORT` (e.e., http://localhost:8000).

    let allKanjiData = {};
    let currentKanjiData = {};
    let learnedKanji = JSON.parse(localStorage.getItem("learnedKanji")) || [];
    let currentFilter = "all";
    let currentPage = 1;
    const itemsPerPage = 50;

    const kanjiListContainer = document.getElementById("kanji-list");
    const jlptCountsEl = document.getElementById("jlpt-counts");
    const currentViewCountEl = document.getElementById("current-view-count");
    const paginationControlsEl = document.getElementById("pagination-controls");
    const filterButtons = document.querySelectorAll('.filters button');
    const infoBoxArea = document.getElementById("info-box-area");

    // Speech Synthesis variables
    let synthesizer = null;
    let japaneseVoice = null; // Store the selected Japanese voice here

    // Function to check for speech synthesis support and populate Japanese voices
    function checkVoiceSupport() {
        if ('speechSynthesis' in window) {
            synthesizer = window.speechSynthesis;
            const setVoice = () => {
                japaneseVoice = synthesizer.getVoices().find(voice => voice.lang === 'ja-JP');
                const speechButtons = document.querySelectorAll('.speech-button');

                if (japaneseVoice) {
                    console.log("Japanese voice ready:", japaneseVoice.name);
                    speechButtons.forEach(btn => {
                        btn.disabled = false;
                        btn.title = "Pronounce Kanji";
                    });
                    if (infoBoxArea.querySelector('.speech-warning')) {
                        infoBoxArea.querySelector('.speech-warning').remove();
                    }
                } else {
                    console.warn("No Japanese voices found. Speech synthesis might not work as expected.");
                    speechButtons.forEach(btn => {
                        btn.disabled = true;
                        btn.title = "Speech not available (no Japanese voice found)";
                    });
                    if (!infoBoxArea.querySelector('.speech-warning')) {
                        infoBoxArea.innerHTML += `<div class="info-box error-message speech-warning"><strong>Speech Warning:</strong> No Japanese voices found on your system. Kanji pronunciation might not work. Please check your browser/OS speech settings.</div>`;
                    }
                }
            };

            // If voices are already loaded, set them. Otherwise, wait for voiceschanged event.
            if (synthesizer.getVoices().length) {
                setVoice();
            } else {
                synthesizer.onvoiceschanged = setVoice;
            }
        } else {
            console.error("Speech synthesis not supported by this browser.");
            document.querySelectorAll('.speech-button').forEach(btn => {
                btn.disabled = true;
                btn.title = "Speech synthesis not supported by your browser.";
            });
            infoBoxArea.innerHTML += `<div class="info-box error-message speech-warning"><strong>Speech Warning:</strong> Speech synthesis not supported by your browser. Kanji pronunciation will not work.</div>`;
        }
    }

    async function fetchJsonFile(filePath, isCritical = false) {
      try {
        const response = await fetch(filePath);
        if (!response.ok) {
          let errorDetail = `HTTP error! Status: ${response.status} for ${filePath}.`;
          if (response.status === 0 || response.type === 'opaque' || response.type === 'error') {
            errorDetail = `Failed to fetch '${filePath}'. This common issue might be due to local file access restrictions (CORS). Status: ${response.status}. Please try using a local web server (see comments at the top of the script).`;
          }
          throw new Error(errorDetail);
        }
        return await response.json();
      } catch (error) {
        console.error("Error fetching JSON:", error.message);
        const displayErrorMessage = error.message;
        if (isCritical) {
            infoBoxArea.innerHTML = `<div class="info-box error-message"><b>Critical Setup Error:</b> ${displayErrorMessage}</div>`;
            if(kanjiListContainer.innerHTML.includes("Initializing") || kanjiListContainer.querySelector('.loader')) {
                 kanjiListContainer.innerHTML = `<div class="loader error-message">Cannot initialize. ${displayErrorMessage}</div>`;
            }
        } else if (filePath === `data/${currentFilter}.json`) {
            kanjiListContainer.innerHTML = `<div class="loader error-message">Failed to load data for current filter: ${filePath}.<br>${displayErrorMessage}</div>`;
        }
        return {};
      }
    }

    async function fetchKanjiDataForLevel(level) {
      const fileName = `data/${level}.json`;
      if (level === "learned") {
        if (!allKanjiData || Object.keys(allKanjiData).length === 0) {
          console.warn("'allKanjiData' is empty for 'learned' filter. 'data/all_kanji.json' likely failed to load.");
        }
        return allKanjiData; // Uses pre-loaded allKanjiData
      }
      return await fetchJsonFile(fileName);
    }

    async function loadAndDisplayKanji(level) {
      currentFilter = level;
      currentPage = 1;
      kanjiListContainer.innerHTML = `<div class="loader">Loading ${level.replace(/_/g, " ").toUpperCase()} Kanji...</div>`;
      paginationControlsEl.innerHTML = '';

      filterButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.level === level));
      
      const learnedButton = document.querySelector('button[data-level="learned"]');
      if (level === "learned" && (!allKanjiData || Object.keys(allKanjiData).length === 0)) {
          kanjiListContainer.innerHTML = `<div class="loader error-message">'Learned' filter cannot function because 'data/all_kanji.json' (required for this filter) failed to load or is empty.</div>`;
          currentViewCountEl.textContent = "Displaying: 0 Kanji";
          if (learnedButton) learnedButton.disabled = true;
          updateJLPTCounts(); // Update counts to reflect allKanjiData status
          return;
      }
      // Re-enable learned button if allKanjiData is available (might have been disabled)
      if (learnedButton && allKanjiData && Object.keys(allKanjiData).length > 0) {
          learnedButton.disabled = false;
      }

      currentKanjiData = await fetchKanjiDataForLevel(level);
      updateJLPTCounts();
      renderKanji();
    }

    function renderKanji() {
      const fragment = document.createDocumentFragment();
      let itemsToDisplay = [];
      const sourceData = (currentFilter === "learned") ? allKanjiData : currentKanjiData;

      if (!sourceData || Object.keys(sourceData).length === 0) {
        if (!kanjiListContainer.querySelector('.error-message')) {
             kanjiListContainer.innerHTML = `<div class="loader">No Kanji data found for "${currentFilter}".<br>Please ensure 'data/${currentFilter}.json' exists and is not empty, or that 'data/all_kanji.json' is available for the 'Learned' filter.</div>`;
        }
        currentViewCountEl.textContent = "Displaying: 0 Kanji";
        paginationControlsEl.innerHTML = '';
        return;
      }

      if (currentFilter === "learned") {
        itemsToDisplay = Object.entries(sourceData).filter(([char]) => learnedKanji.includes(char));
      } else {
        itemsToDisplay = Object.entries(sourceData);
      }

      if (itemsToDisplay.length === 0) {
        kanjiListContainer.innerHTML = `<div class="loader">No Kanji characters match the filter: "${currentFilter}".</div>`;
        currentViewCountEl.textContent = "Displaying: 0 Kanji";
        paginationControlsEl.innerHTML = '';
        return;
      }

      const totalItemsInCurrentFilter = itemsToDisplay.length;
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedItems = itemsToDisplay.slice(startIndex, endIndex);

      currentViewCountEl.textContent = `Displaying ${paginatedItems.length} of ${totalItemsInCurrentFilter} Kanji (Page ${currentPage})`;

      paginatedItems.forEach(([char, info]) => {
        const card = document.createElement("div");
        card.className = "kanji-card";
        card.dataset.char = char;

        const isLearned = learnedKanji.includes(char);
        const meanings = info && info.meanings ? info.meanings.join(', ') : 'N/A';
        const readings_on = info && info.readings_on ? info.readings_on.join(', ') : 'N/A';
        const readings_kun = info && info.readings_kun ? info.readings_kun.join(', ') : 'N/A';
        const strokes = info && info.strokes || 'N/A';
        const grade = info && info.grade || 'N/A';
        const jlptLevel = info && (info.jlpt_new || info.jlpt_old);
        const jlptDisplay = jlptLevel ? `N${jlptLevel}` : 'N/A';
        const wk_level_html = info && info.wk_level ? `<div><span class="field-label">WK Level:</span> ${info.wk_level}</div>` : '';

        card.innerHTML = `
          <div class="kanji-char">
            ${char}
            <button class="speech-button" data-char="${char}" ${!japaneseVoice ? 'disabled title="Speech not available"' : ''}>🔊</button>
          </div>
          <div class="kanji-details">
            <div><span class="field-label">Meanings:</span> ${meanings}</div>
            <div><span class="field-label">On:</span> ${readings_on}</div>
            <div><span class="field-label">Kun:</span> ${readings_kun}</div>
            <div><span class="field-label">Strokes:</span> ${strokes}</div>
            <div><span class="field-label">Grade:</span> ${grade}</div>
            <div><span class="field-label">JLPT:</span> ${jlptDisplay}</div>
            ${wk_level_html}
          </div>
          <button class="learned-btn ${isLearned ? 'is-learned' : ''}" data-char="${char}">
            ${isLearned ? 'Mark as Unlearned' : 'Mark as Learned'}
          </button>
        `;
        fragment.appendChild(card);
      });

      kanjiListContainer.innerHTML = '';
      kanjiListContainer.appendChild(fragment);
      renderPaginationControls(totalItemsInCurrentFilter);
      attachLearnedButtonListeners();
      attachSpeechButtonListeners(); // Attach listeners for speech buttons
      checkVoiceSupport(); // Re-check voice support after rendering new buttons
    }

    function attachLearnedButtonListeners() {
      document.querySelectorAll(".learned-btn").forEach(btn => {
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        newBtn.addEventListener("click", (e) => {
          if (e.target.disabled) return;
          const char = e.target.dataset.char;
          const index = learnedKanji.indexOf(char);
          if (index === -1) {
            learnedKanji.push(char);
          } else {
            learnedKanji.splice(index, 1);
          }
          localStorage.setItem("learnedKanji", JSON.stringify(learnedKanji));
          newBtn.classList.toggle("is-learned", index === -1);
          newBtn.textContent = (index === -1) ? "Mark as Unlearned" : "Mark as Learned";
          if (currentFilter === "learned") {
            currentPage = 1;
            renderKanji();
          }
          updateJLPTCounts();
        });
      });
    }

    // New function to attach speech button listeners
    function attachSpeechButtonListeners() {
        document.querySelectorAll(".speech-button").forEach(btn => {
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.addEventListener("click", (e) => {
                if (!japaneseVoice || !synthesizer || e.target.disabled) {
                    console.warn("Speech synthesis is not available or button is disabled.");
                    return;
                }
                const charToSpeak = e.target.dataset.char;
                speakKanji(charToSpeak);
            });
        });
    }

    // Function to speak the Kanji
    function speakKanji(kanjiChar) {
        if (!japaneseVoice || !synthesizer) {
            console.warn("Speech synthesis not available or no Japanese voice selected.");
            return;
        }

        // Stop any ongoing speech before starting a new one
        if (synthesizer.speaking) {
            synthesizer.cancel();
        }

        const utterance = new SpeechSynthesisUtterance(kanjiChar);
        utterance.lang = 'ja-JP';
        utterance.voice = japaneseVoice; // Use the globally stored Japanese voice
        utterance.rate = 0.8; // Adjust speech rate if needed
        utterance.pitch = 1;  // Adjust pitch if needed

        synthesizer.speak(utterance);
    }


    function renderPaginationControls(totalItems) {
      paginationControlsEl.innerHTML = '';
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      if (totalPages <= 1) return;
      if (currentPage > 1) {
        const prevButton = document.createElement('button');
        prevButton.textContent = 'Previous';
        prevButton.addEventListener('click', () => { currentPage--; renderKanji(); });
        paginationControlsEl.appendChild(prevButton);
      }
      const pageInfo = document.createElement('span');
      pageInfo.textContent = ` Page ${currentPage} of ${totalPages} `;
      pageInfo.style.margin = "0 10px";
      paginationControlsEl.appendChild(pageInfo);
      if (currentPage < totalPages) {
        const nextButton = document.createElement('button');
        nextButton.textContent = 'Next';
        nextButton.addEventListener('click', () => { currentPage++; renderKanji(); });
        paginationControlsEl.appendChild(nextButton);
      }
    }

    function updateJLPTCounts() {
      const dataForCounting = allKanjiData;
      const counts = { n1: 0, n2: 0, n3: 0, n4: 0, n5: 0, other: 0 };
      let totalInDataset = 0;
      const currentLearnedCount = learnedKanji.length;

      if (dataForCounting && Object.keys(dataForCounting).length > 0) {
        for (const char in dataForCounting) {
          if (dataForCounting.hasOwnProperty(char)) {
            totalInDataset++;
            const info = dataForCounting[char];
            const jlptLevel = info.jlpt_new || info.jlpt_old;
            if (jlptLevel === 1) counts.n1++;
            else if (jlptLevel === 2) counts.n2++;
            else if (jlptLevel === 3) counts.n3++;
            else if (jlptLevel === 4) counts.n4++;
            else if (jlptLevel === 5) counts.n5++;
            else counts.other++;
          }
        }
        jlptCountsEl.innerHTML = `Total (All Data): ${totalInDataset} | N5: ${counts.n5} | N4: ${counts.n4} | N3: ${counts.n3} | N2: ${counts.n2} | N1: ${counts.n1} | Other: ${counts.other} | Learned: <span id="learned-count">${currentLearnedCount}</span>`;
      } else {
        jlptCountsEl.innerHTML = `<span class="error-message">Global counts unavailable ('data/all_kanji.json' missing/empty).</span> Learned: <span id="learned-count">${currentLearnedCount}</span>`;
      }
      const learnedCountEl = document.getElementById('learned-count');
      if(learnedCountEl) learnedCountEl.textContent = currentLearnedCount;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      infoBoxArea.innerHTML = `<div class="info-box"><strong>Tip:</strong> If Kanji don't load, check the browser console (F12) for errors. You might need to use a local web server (see script comments). Ensure 'data/all_kanji.json' and other data files are in the 'data' folder next to this HTML file.</div>`;
      checkVoiceSupport(); // Initial voice check

      filterButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
          const levelToLoad = e.target.dataset.level;
          if (e.target.disabled) return;
          loadAndDisplayKanji(levelToLoad);
        });
      });

      console.log("Page Initializing: Attempting to fetch 'data/all_kanji.json' (critical for full functionality)...");
      allKanjiData = await fetchJsonFile('data/all_kanji.json', true); // Mark as critical

      const learnedButton = document.querySelector('button[data-level="learned"]');
      if (!allKanjiData || Object.keys(allKanjiData).length === 0) {
        console.error("CRITICAL FAILURE: 'data/all_kanji.json' could not be loaded or is empty. This file is essential. Check its path and content.");
        if (learnedButton) {
          learnedButton.disabled = true;
          learnedButton.title = "'data/all_kanji.json' is required and failed to load.";
        }
        // The error message from fetchJsonFile (if critical) should already be in infoBoxArea and kanjiListContainer.
      } else {
        console.log("'data/all_kanji.json' loaded successfully (" + Object.keys(allKanjiData).length + " entries).");
        if (learnedButton) {
          learnedButton.disabled = false;
          learnedButton.title = "";
        }
      }
      
      updateJLPTCounts(); // Initial update of counts based on allKanjiData load status

      const defaultFilterLevel = "all";
      const defaultFilterButton = document.querySelector(`.filters button[data-level="${defaultFilterLevel}"]`);

      if (defaultFilterButton) {
        if (defaultFilterLevel === "all" && (!allKanjiData || Object.keys(allKanjiData).length === 0)) {
          console.warn(`Default filter '${defaultFilterLevel}' not loaded because its primary data source ('all_kanji.json') failed or is empty.`);
          // Error message from all_kanji.json failure should be visible.
          // If the kanjiListContainer still has its initial "Initializing..." message, replace it.
          if (kanjiListContainer.textContent.includes("Initializing")) {
             kanjiListContainer.innerHTML = `<div class="loader error-message">Default view ('All Kanji') cannot be loaded as the core 'data/all_kanji.json' file is missing or empty.</div>`;
          }
        } else {
          console.log(`Loading default view: ${defaultFilterLevel}`);
          await loadAndDisplayKanji(defaultFilterLevel);
        }
      } else {
        console.error(`Configuration error: Default filter button for '${defaultFilterLevel}' not found.`);
        kanjiListContainer.innerHTML = `<div class="loader error-message">Internal error: Default filter button missing.</div>`;
      }
    });
    // --- End of Script ---
    </script>
</body>
</html>