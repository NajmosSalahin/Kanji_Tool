<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Kanji Vault - Complete</title>
    <!-- Tailwind CSS for modern and responsive styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Custom Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles to complement Tailwind and apply specific fonts */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f1f5f9;
        }
        .japanese { 
            font-family: 'Noto Sans JP', sans-serif; 
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        body, .kanji-card, header, #search-input, .filters button, .info-box {
            transition: background-color 0.3s, color 0.3s, border-color 0.3s, box-shadow 0.3s, transform 0.2s ease-in-out;
        }
        
        /* Styles for learned cards */
        .kanji-card.learned {
            opacity: 0.6;
            border-left-width: 4px;
            border-left-color: #34d399; /* A nice green color */
        }
        .kanji-card.learned:hover {
            opacity: 1;
        }

        /* Dark mode styles */
        .dark body { background-color: #0f172a; color: #e2e8f0; }
        .dark .kanji-card { background-color: #1e293b; border-color: #334155; }
        .dark .kanji-card.learned { border-left-color: #10b981; }
        .dark header { background-color: #1e293b; }
        .dark #search-input { background-color: #334155; color: #f8fafc; border-color: #475569; }
        .dark #search-input::placeholder { color: #94a3b8; }
        .dark .filters { background-color: #1e293bDD; border-color: #334155; }
        .dark .filters button { background-color: #334155; color: #e2e8f0; }
        .dark .filters button:hover { background-color: #475569; }
        .dark .filters button.active { background-color: #4f46e5; color: white; }
        .dark .info-box { background-color: #1e293b; border-color: #334155; color: #94a3b8; }
        .dark .loader-text { color: #e2e8f0; }
        .dark ::-webkit-scrollbar-track { background: #0f172a; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; }
        .dark ::-webkit-scrollbar-thumb:hover { background: #475569; }
    </style>
</head>
<body class="antialiased">
    <header class="bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm shadow-md sticky top-0 z-20 py-4 px-4 sm:px-6">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <h1 class="text-2xl sm:text-3xl font-bold text-slate-800 dark:text-white japanese">漢字金庫</h1>
            <div class="flex items-center space-x-2">
                <input type="text" id="search-input" placeholder="Search anything..." class="w-40 sm:w-64 px-3 py-2 border border-slate-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition duration-200 bg-slate-50 dark:bg-slate-800">
                <button id="theme-toggle" class="p-2 rounded-lg text-slate-500 dark:text-slate-400 hover:bg-slate-100 dark:hover:bg-slate-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-50 dark:focus:ring-offset-slate-900 focus:ring-slate-500">
                    <svg id="theme-toggle-dark-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path></svg>
                    <svg id="theme-toggle-light-icon" class="hidden w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.706.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 6.464A1 1 0 106.465 5.05l-.708-.707a1 1 0 00-1.414 1.414l.707.707zm1.414 8.486l-.707.707a1 1 0 01-1.414-1.414l.707-.707a1 1 0 011.414 1.414zM4 11a1 1 0 100-2H3a1 1 0 000 2h1z" fill-rule="evenodd" clip-rule="evenodd"></path></svg>
                </button>
            </div>
        </div>
    </header>

    <div class="filters sticky top-[88px] z-10 bg-white/80 dark:bg-slate-900/80 backdrop-blur-sm py-3 px-4 border-b border-slate-200 dark:border-slate-700">
        <div class="max-w-7xl mx-auto flex flex-wrap justify-center items-center gap-2">
            <button data-level="all" class="px-3 py-1.5 text-sm font-medium rounded-lg shadow-sm transition-all duration-200">All</button>
            <button data-level="n5" class="px-3 py-1.5 text-sm font-medium rounded-lg shadow-sm transition-all duration-200">N5</button>
            <button data-level="n4" class="px-3 py-1.5 text-sm font-medium rounded-lg shadow-sm transition-all duration-200">N4</button>
            <button data-level="n3" class="px-3 py-1.5 text-sm font-medium rounded-lg shadow-sm transition-all duration-200">N3</button>
            <button data-level="n2" class="px-3 py-1.5 text-sm font-medium rounded-lg shadow-sm transition-all duration-200">N2</button>
            <button data-level="n1" class="px-3 py-1.5 text-sm font-medium rounded-lg shadow-sm transition-all duration-200">N1</button>
            <button data-level="other" class="px-3 py-1.5 text-sm font-medium rounded-lg shadow-sm transition-all duration-200">Other</button>
        </div>
    </div>
    
    <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
      <div id="kanji-list-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4 p-4">
        <div id="loader" class="col-span-full flex justify-center items-center py-20">
          <div class="text-center">
            <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            <p class="mt-2 text-lg font-medium loader-text">Initializing Kanji Vault...</p>
          </div>
        </div>
      </div>
      <div id="no-results" class="hidden col-span-full text-center py-20">
        <p class="text-xl font-medium text-slate-500 dark:text-slate-400">No Kanji found for your search.</p>
      </div>
    </main>

    <script type="module">
    // --- Application State and Data Store ---
    let allKanjiData = {};
    let kanjiByLevel = {};
    let learnedKanji = new Set();
    let currentFilter = 'all';

    // DOM Elements
    const kanjiListContainer = document.getElementById('kanji-list-container');
    const searchInput = document.getElementById('search-input');
    const filterButtons = document.querySelectorAll('.filters button');
    const noResultsDiv = document.getElementById('no-results');
    const loader = document.getElementById('loader');

    // --- Learned Kanji Management ---
    function loadLearnedKanji() {
        const saved = localStorage.getItem('learnedKanji');
        if (saved) {
            learnedKanji = new Set(JSON.parse(saved));
        }
    }

    function saveLearnedKanji() {
        localStorage.setItem('learnedKanji', JSON.stringify([...learnedKanji]));
    }

    // --- Data Fetching Logic ---
    async function fetchJson(url) {
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return await response.json();
        } catch (e) {
            console.error(`Failed to fetch ${url}:`, e);
            loader.innerHTML = `<p class="text-red-500 text-center col-span-full">Error loading data from <code>${url}</code>. Please check if the file exists and the path is correct.</p>`;
            return null;
        }
    }
    
    async function loadAllData() {
        loader.classList.remove('hidden');
        kanjiListContainer.innerHTML = '';
        
        const dataFiles = {
            all: 'data/all.json', n5: 'data/jlpt_n5.json', n4: 'data/jlpt_n4.json',
            n3: 'data/jlpt_n3.json', n2: 'data/jlpt_n2.json', n1: 'data/jlpt_n1.json', other: 'data/jlpt_other.json'
        };

        const allKanjiPromise = fetchJson(dataFiles.all);
        const levelPromises = Object.entries(dataFiles)
            .filter(([level]) => level !== 'all')
            .map(async ([level, path]) => {
                const data = await fetchJson(path);
                kanjiByLevel[level] = data ? Object.keys(data) : [];
            });
        
        allKanjiData = await allKanjiPromise;
        await Promise.all(levelPromises);
        
        if (!allKanjiData) return false; 
        
        kanjiByLevel.all = Object.keys(allKanjiData);

        updateFilterCounts();
        loader.classList.add('hidden');
        return true;
    }
    
    function updateFilterCounts() {
        filterButtons.forEach(button => {
            const level = button.dataset.level;
            const count = kanjiByLevel[level] ? kanjiByLevel[level].length : 0;
            button.innerHTML = `${level.toUpperCase()} (<span class="count">${count}</span>)`;
        });
    }

    // --- Romaji Conversion Utility ---
    const kanaToRomaji = (() => {
        const kanaMap = {'あ':'a','い':'i','う':'u','え':'e','お':'o','か':'ka','き':'ki','く':'ku','け':'ke','こ':'ko','さ':'sa','し':'shi','す':'su','せ':'se','そ':'so','た':'ta','ち':'chi','つ':'tsu','て':'te','と':'to','な':'na','に':'ni','ぬ':'nu','ね':'ne','の':'no','は':'ha','ひ':'hi','ふ':'fu','へ':'he','ほ':'ho','ま':'ma','み':'mi','む':'mu','め':'me','も':'mo','や':'ya','ゆ':'yu','よ':'yo','ら':'ra','り':'ri','る':'ru','れ':'re','ろ':'ro','わ':'wa','を':'o','ん':'n','が':'ga','ぎ':'gi','ぐ':'gu','げ':'ge','ご':'go','ざ':'za','じ':'ji','ず':'zu','ぜ':'ze','ぞ':'zo','だ':'da','ぢ':'ji','づ':'zu','で':'de','ど':'do','ば':'ba','び':'bi','ぶ':'bu','べ':'be','ぼ':'bo','ぱ':'pa','ぴ':'pi','ぷ':'pu','ぺ':'pe','ぽ':'po','きゃ':'kya','きゅ':'kyu','きょ':'kyo','しゃ':'sha','しゅ':'shu','しょ':'sho','ちゃ':'cha','ちゅ':'chu','ちょ':'cho','にゃ':'nya','にゅ':'nyu','にょ':'nyo','ひゃ':'hya','ひゅ':'hyu','ひょ':'hyo','みゃ':'mya','みゅ':'myu','みょ':'myo','りゃ':'rya','りゅ':'ryu','りょ':'ryo','ぎゃ':'gya','ぎゅ':'gyu','ぎょ':'gyo','じゃ':'ja','じゅ':'ju','じょ':'jo','びゃ':'bya','びゅ':'byu','びょ':'byo','ぴゃ':'pya','ぴゅ':'pyu','ぴょ':'pyo','ア':'a','イ':'i','ウ':'u','エ':'e','オ':'o','カ':'ka','キ':'ki','ク':'ku','ケ':'ke','コ':'ko','サ':'sa','シ':'shi','ス':'su','セ':'se','ソ':'so','タ':'ta','チ':'chi','ツ':'tsu','テ':'te','ト':'to','ナ':'na','ニ':'ni','ヌ':'nu','ネ':'ne','ノ':'no','ハ':'ha','ヒ':'hi','フ':'fu','ヘ':'he','ホ':'ho','マ':'ma','ミ':'mi','ム':'mu','メ':'me','モ':'mo','ヤ':'ya','ユ':'yu','ヨ':'yo','ラ':'ra','リ':'ri','ル':'ru','レ':'re','ロ':'ro','ワ':'wa','ヲ':'o','ン':'n','ガ':'ga','ギ':'gi','グ':'gu','ゲ':'ge','ゴ':'go','ザ':'za','ジ':'ji','ズ':'zu','ゼ':'ze','ゾ':'zo','ダ':'da','ヂ':'ji','ヅ':'zu','デ':'de','ド':'do','バ':'ba','ビ':'bi','ブ':'bu','ベ':'be','ボ':'bo','パ':'pa','ピ':'pi','プ':'pu','ペ':'pe','ポ':'po','キャ':'kya','キュ':'kyu','キョ':'kyo','シャ':'sha','シュ':'shu','ショ':'sho','チャ':'cha','チュ':'chu','チョ':'cho','ニャ':'nya','ニュ':'nyu','ニョ':'nyo','ヒャ':'hya','ヒュ':'hyu','ヒョ':'hyo','ミャ':'mya','ミュ':'myu','ミョ':'myo','リャ':'rya','リュ':'ryu','リョ':'ryo','ギャ':'gya','ギュ':'gyu','ギョ':'gyo','ジャ':'ja','ジュ':'ju','ジョ':'jo','ビャ':'bya','ビュ':'byu','ビョ':'byo','ピャ':'pya','ピュ':'pyu','ピョ':'pyo'};
        return(kana)=>{if(!kana)return'';let[baseKana]=kana.split('.');let romaji='';let i=0;while(i<baseKana.length){let found=!1;if(i+1<baseKana.length){const twoChar=baseKana.substring(i,i+2);if(kanaMap[twoChar]){romaji+=kanaMap[twoChar];i+=2;found=!0;}}if(!found){const oneChar=baseKana.charAt(i);if(oneChar==='っ'||oneChar==='ッ'){if(i+1<baseKana.length){const nextChar=baseKana.charAt(i+1);const nextRomaji=kanaMap[nextChar];if(nextRomaji){romaji+=nextRomaji.charAt(0);}}}else{romaji+=kanaMap[oneChar]||oneChar;}i++;}}return romaji;};
    })();

    // --- UI and Display Logic ---
    function createKanjiCard(kanji, data) {
        const card = document.createElement('div');
        const isLearned = learnedKanji.has(kanji);
        card.className = `kanji-card relative bg-white dark:bg-slate-800 rounded-lg shadow-md p-4 flex flex-col justify-between border border-slate-200 dark:border-slate-700 hover:shadow-xl hover:-translate-y-1 ${isLearned ? 'learned' : ''}`;
        card.dataset.kanji = kanji;
        
        const onReadings = data.readings_on.join('、 ');
        const kunReadings = data.readings_kun.join('、 ');

        card.innerHTML = `
            <div>
                 <div class="absolute top-2 right-2 flex space-x-1">
                    <button class="speak-btn p-1.5 text-slate-400 hover:text-indigo-500 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9.383 3.076A1 1 0 0110 4v12a1 1 0 01-1.707.707L4.586 13H2a1 1 0 01-1-1V8a1 1 0 011-1h2.586l3.707-3.707a1 1 0 011.09-.217zM14.657 2.929a1 1 0 011.414 0A9.972 9.972 0 0119 10a9.972 9.972 0 01-2.929 7.071 1 1 0 01-1.414-1.414A7.971 7.971 0 0017 10c0-2.21-.894-4.208-2.343-5.657a1 1 0 010-1.414zm-2.829 2.828a1 1 0 011.415 0A5.983 5.983 0 0115 10a5.984 5.984 0 01-1.757 4.243 1 1 0 01-1.415-1.415A3.984 3.984 0 0013 10a3.983 3.983 0 00-1.172-2.828 1 1 0 010-1.415z" clip-rule="evenodd" /></svg>
                    </button>
                    <button class="learn-btn p-1.5 text-slate-400 hover:text-green-500 rounded-full hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                    </button>
                </div>
                <p class="japanese text-6xl text-center mb-2 text-slate-900 dark:text-white">${kanji}</p>
                <div class="text-sm space-y-2">
                    <p class="font-semibold text-slate-700 dark:text-slate-300">Meanings: <span class="font-normal text-slate-600 dark:text-slate-400">${data.meanings.join(', ')}</span></p>
                    <div>
                        <p class="font-semibold text-slate-700 dark:text-slate-300">On'yomi:</p>
                        <p class="text-slate-600 dark:text-slate-400 japanese">${onReadings || 'N/A'}</p>
                        <p class="text-xs text-indigo-500 dark:text-indigo-400">${kanaToRomaji(onReadings)}</p>
                    </div>
                    <div>
                        <p class="font-semibold text-slate-700 dark:text-slate-300">Kun'yomi:</p>
                        <p class="text-slate-600 dark:text-slate-400 japanese">${kunReadings || 'N/A'}</p>
                        <p class="text-xs text-indigo-500 dark:text-indigo-400">${kanaToRomaji(kunReadings)}</p>
                    </div>
                </div>
            </div>
            <div class="text-xs text-slate-400 dark:text-slate-500 mt-4 pt-2 border-t border-slate-200 dark:border-slate-700 flex justify-between">
                <span>Grade: ${data.grade || 'N/A'}</span>
                <span>Strokes: ${data.strokes}</span>
                <span>JLPT: N${data.jlpt_new || '?'}</span>
            </div>
        `;
        return card;
    }

    function renderKanjiList(kanjiListToRender) {
        kanjiListContainer.innerHTML = ''; 
        if (kanjiListToRender.length === 0) {
            noResultsDiv.classList.remove('hidden');
        } else {
            noResultsDiv.classList.add('hidden');
            const fragment = document.createDocumentFragment();
            kanjiListToRender.forEach(kanji => {
                if (allKanjiData[kanji]) {
                    fragment.appendChild(createKanjiCard(kanji, allKanjiData[kanji]));
                }
            });
            kanjiListContainer.appendChild(fragment);
        }
    }
    
    // --- Event Handling and Logic ---
    function handleCardInteraction(e) {
        const speakBtn = e.target.closest('.speak-btn');
        const learnBtn = e.target.closest('.learn-btn');

        if (speakBtn) {
            const card = speakBtn.closest('.kanji-card');
            const kanji = card.dataset.kanji;
            const utterance = new SpeechSynthesisUtterance(kanji);
            utterance.lang = 'ja-JP';
            speechSynthesis.speak(utterance);
        }

        if (learnBtn) {
            const card = learnBtn.closest('.kanji-card');
            const kanji = card.dataset.kanji;
            if (learnedKanji.has(kanji)) {
                learnedKanji.delete(kanji);
                card.classList.remove('learned');
            } else {
                learnedKanji.add(kanji);
                card.classList.add('learned');
            }
            saveLearnedKanji();
        }
    }
    
    function filterAndSearch() {
        const query = searchInput.value.toLowerCase().trim();
        const baseList = kanjiByLevel[currentFilter] || [];
        
        const filteredList = !query ? baseList : baseList.filter(kanji => {
            const data = allKanjiData[kanji];
            if (!data) return false;
            
            const isKanji = kanji === query;
            const inMeanings = data.meanings.some(m => m.toLowerCase().includes(query));
            const inOnYomi = data.readings_on.some(r => r.includes(query) || kanaToRomaji(r).toLowerCase().includes(query));
            const inKunYomi = data.readings_kun.some(r => kanaToRomaji(r).toLowerCase().includes(query) || r.split('.')[0].includes(query));
            const isGrade = `grade:${data.grade}` === query || `g${data.grade}` === query;
            const isStrokes = `strokes:${data.strokes}` === query || `s${data.strokes}` === query;
            const isJlpt = `n${data.jlpt_new}` === query;

            return isKanji || inMeanings || inOnYomi || inKunYomi || isGrade || isStrokes || isJlpt;
        });

        renderKanjiList(filteredList);
    }
    
    function handleFilterClick(level) {
        currentFilter = level;
        filterButtons.forEach(btn => {
            const isActive = btn.dataset.level === level;
            btn.classList.toggle('active', isActive);
            btn.classList.toggle('bg-indigo-600', isActive);
            btn.classList.toggle('text-white', isActive);
            btn.classList.toggle('dark:bg-slate-800', !isActive);
        });
        filterAndSearch();
    }

    // --- Dark Mode Toggle ---
    const themeToggleBtn = document.getElementById('theme-toggle');
    const darkIcon = document.getElementById('theme-toggle-dark-icon');
    const lightIcon = document.getElementById('theme-toggle-light-icon');
    
    if (localStorage.getItem('color-theme') === 'dark' || (!('color-theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
        lightIcon.classList.remove('hidden');
    } else {
        darkIcon.classList.remove('hidden');
    }

    themeToggleBtn.addEventListener('click', () => {
        darkIcon.classList.toggle('hidden');
        lightIcon.classList.toggle('hidden');
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('color-theme', isDark ? 'dark' : 'light');
    });

    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', async () => {
        loadLearnedKanji();

        let searchTimeout;
        searchInput.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(filterAndSearch, 300);
        });

        filterButtons.forEach(button => {
            button.addEventListener('click', () => handleFilterClick(button.dataset.level));
        });

        kanjiListContainer.addEventListener('click', handleCardInteraction);

        const dataLoaded = await loadAllData();
        if (dataLoaded) {
            handleFilterClick('all');
        }
    });
    </script>
</body>
</html>
