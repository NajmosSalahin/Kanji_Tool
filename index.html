<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Kanji Vault - Fast with Search and Romaji</title>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 0; color: #333; }
        header { background: #2c3e50; color: white; padding: 15px 20px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        header h1 { margin: 0; font-size: 1.8em; }
        .info-box { padding: 10px; margin: 10px 20px; background-color: #fff3cd; border: 1px solid #ffeeba; color: #856404; border-radius: 5px; text-align: center; font-size: 0.9em;}
        .filters { padding: 15px; text-align: center; background-color: #fff; border-bottom: 1px solid #ddd; flex-wrap: wrap; display: flex; justify-content: center;}
        .filters button { margin: 5px; padding: 10px 15px; border: none; border-radius: 5px; background: #3498db; color: white; cursor: pointer; font-size: 0.9em; transition: background-color 0.2s ease; }
        .filters button:hover { background: #2980b9; }
        .filters button.active { background: #e74c3c; }
        .filters button:disabled { background-color: #aaa; cursor: not-allowed; opacity: 0.7;}
        .status-bar { display: flex; flex-direction: column; align-items: center; gap: 10px; padding: 10px 20px; background: #ecf0f1; font-size: 0.9em; text-align: center;}
        @media (min-width: 768px) { .status-bar { flex-direction: row; justify-content: space-between; } }
        .counter-bar { font-weight: bold; }
        #search-input {
            padding: 8px 12px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 0.9em;
            width: 250px;
        }
        .kanji-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 15px; padding: 20px; min-height: 200px; /* Ensure it's visible even when empty */ }
        .kanji-card { background: white; border-radius: 8px; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); display: flex; flex-direction: column; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .kanji-card:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.08); }
        .kanji-char { font-size: 3.5em; color: #2c3e50; text-align: center; margin-bottom: 10px; position: relative; }
        .kanji-details div { margin-bottom: 6px; font-size: 0.85em; word-wrap: break-word; }
        .kanji-details .field-label { font-weight: bold; color: #555; }
        .kanji-details .romaji { font-size: 0.75em; color: #777; margin-left: 5px; } /* Style for Romaji */
        .learned-btn { margin-top: auto; padding: 8px 12px; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9; color: #333; cursor: pointer; text-align: center; font-size: 0.85em; transition: background-color 0.2s ease, color 0.2s ease; }
        .learned-btn.is-learned { background: #2ecc71; color: white; border-color: #27ae60;}
        .learned-btn:hover:not(:disabled) { background: #e9e9e9; }
        .learned-btn.is-learned:hover:not(:disabled) { background: #27ae60; }
        #pagination-controls { text-align: center; padding: 20px; }
        #pagination-controls button { margin: 0 5px; padding: 8px 15px; background-color: #3498db; color:white; border: none; border-radius: 4px; cursor: pointer; }
        #pagination-controls button:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .loader { text-align: center; padding: 30px; font-size: 1.2em; color: #555;}
        .error-message { color: red; font-weight: bold; }
        .speech-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            color: #3498db;
            padding: 0;
            line-height: 1;
            transition: color 0.2s ease;
        }
        .speech-button:hover { color: #2980b9; }
        .speech-button:disabled { color: #aaa; cursor: not-allowed; }
    </style>
</head>
<body>
    <header><h1>Kanji Vault</h1></header>
    <div id="info-box-area"></div>
    <div class="filters">
        <button data-level="all">All Kanji</button>
        <button data-level="jlpt_n5">JLPT N5</button>
        <button data-level="jlpt_n4">JLPT N4</button>
        <button data-level="jlpt_n3">JLPT N3</button>
        <button data-level="jlpt_n2">JLPT N2</button>
        <button data-level="jlpt_n1">JLPT N1</button>
        <button data-level="jlpt_other">Other Kanji</button>
        <button data-level="learned">Learned</button>
    </div>
    <div class="status-bar">
        <div id="jlpt-counts" class="counter-bar">Loading counts...</div>
        <!-- Search Input Added Here -->
        <input type="text" id="search-input" placeholder="Search current view...">
        <div id="current-view-count">Displaying: 0 Kanji</div>
    </div>
    <div id="kanji-list" class="kanji-grid">
        <div class="loader">Initializing and attempting to load core data... Please ensure 'data/all_kanji.json' exists.</div>
    </div>
    <div id="pagination-controls"></div>

    <script>
    // --- Start of Script ---
    let allKanjiData = {};
    let currentKanjiData = {};
    let learnedKanji = JSON.parse(localStorage.getItem("learnedKanji")) || [];
    let currentFilter = "all";
    let currentPage = 1;
    const itemsPerPage = 50;

    const kanjiListContainer = document.getElementById("kanji-list");
    const jlptCountsEl = document.getElementById("jlpt-counts");
    const currentViewCountEl = document.getElementById("current-view-count");
    const paginationControlsEl = document.getElementById("pagination-controls");
    const filterButtons = document.querySelectorAll('.filters button');
    const infoBoxArea = document.getElementById("info-box-area");
    const searchInput = document.getElementById("search-input"); // Search input element

    // Speech Synthesis variables
    let synthesizer = null;
    let japaneseVoice = null;

    // --- NEW: Romaji Conversion Function ---
    // This is a simplified conversion and might not cover all nuances of Romaji.
    // For a more robust solution, a dedicated library would be ideal.
    function toRomaji(japaneseText) {
        if (!japaneseText) return '';
        let romaji = japaneseText;

        // Common hiragana conversions
        romaji = romaji.replace(/ã‚/g, 'a').replace(/ã„/g, 'i').replace(/ã†/g, 'u').replace(/ãˆ/g, 'e').replace(/ãŠ/g, 'o');
        romaji = romaji.replace(/ã‹/g, 'ka').replace(/ã/g, 'ki').replace(/ã/g, 'ku').replace(/ã‘/g, 'ke').replace(/ã“/g, 'ko');
        romaji = romaji.replace(/ã•/g, 'sa').replace(/ã—/g, 'shi').replace(/ã™/g, 'su').replace(/ã›/g, 'se').replace(/ã/g, 'so');
        romaji = romaji.replace(/ãŸ/g, 'ta').replace(/ã¡/g, 'chi').replace(/ã¤/g, 'tsu').replace(/ã¦/g, 'te').replace(/ã¨/g, 'to');
        romaji = romaji.replace(/ãª/g, 'na').replace(/ã«/g, 'ni').replace(/ã¬/g, 'nu').replace(/ã­/g, 'ne').replace(/ã®/g, 'no');
        romaji = romaji.replace(/ã¯/g, 'ha').replace(/ã²/g, 'hi').replace(/ãµ/g, 'fu').replace(/ã¸/g, 'he').replace(/ã»/g, 'ho');
        romaji = romaji.replace(/ã¾/g, 'ma').replace(/ã¿/g, 'mi').replace(/ã‚€/g, 'mu').replace(/ã‚/g, 'me').replace(/ã‚‚/g, 'mo');
        romaji = romaji.replace(/ã‚„/g, 'ya').replace(/ã‚†/g, 'yu').replace(/ã‚ˆ/g, 'yo');
        romaji = romaji.replace(/ã‚‰/g, 'ra').replace(/ã‚Š/g, 'ri').replace(/ã‚‹/g, 'ru').replace(/ã‚Œ/g, 're').replace(/ã‚/g, 'ro');
        romaji = romaji.replace(/ã‚/g, 'wa').replace(/ã‚’/g, 'wo').replace(/ã‚“/g, 'n');

        // Dakuten/Handakuten
        romaji = romaji.replace(/ãŒ/g, 'ga').replace(/ãŽ/g, 'gi').replace(/ã/g, 'gu').replace(/ã’/g, 'ge').replace(/ã”/g, 'go');
        romaji = romaji.replace(/ã–/g, 'za').replace(/ã˜/g, 'ji').replace(/ãš/g, 'zu').replace(/ãœ/g, 'ze').replace(/ãž/g, 'zo');
        romaji = romaji.replace(/ã /g, 'da').replace(/ã¢/g, 'ji').replace(/ã¥/g, 'zu').replace(/ã§/g, 'de').replace(/ã©/g, 'do');
        romaji = romaji.replace(/ã°/g, 'ba').replace(/ã³/g, 'bi').replace(/ã¶/g, 'bu').replace(/ã¹/g, 'be').replace(/ã¼/g, 'bo');
        romaji = romaji.replace(/ã±/g, 'pa').replace(/ã´/g, 'pi').replace(/ã·/g, 'pu').replace(/ãº/g, 'pe').replace(/ã½/g, 'po');

        // Small kana
        romaji = romaji.replace(/ã‚ƒ/g, 'ya').replace(/ã‚…/g, 'yu').replace(/ã‚‡/g, 'yo');
        romaji = romaji.replace(/ã£ã‹/g, 'kka').replace(/ã£ã/g, 'kki').replace(/ã£ã/g, 'kku').replace(/ã£ã‘/g, 'kke').replace(/ã£ã“/g, 'kko');
        romaji = romaji.replace(/ã£ã•/g, 'ssa').replace(/ã£ã—/g, 'sshi').replace(/ã£ã™/g, 'ssu').replace(/ã£ã›/g, 'sse').replace(/ã£ã/g, 'sso');
        romaji = romaji.replace(/ã£ãŸ/g, 'tta').replace(/ã£ã¡/g, 'tchi').replace(/ã£ã¤/g, 'ttsu').replace(/ã£ã¦/g, 'tte').replace(/ã£ã¨/g, 'tto');
        // Add more small kana conversions as needed

        // Katakana (simple conversion, assumes similar sounds)
        romaji = romaji.replace(/ã‚¢/g, 'a').replace(/ã‚¤/g, 'i').replace(/ã‚¦/g, 'u').replace(/ã‚¨/g, 'e').replace(/ã‚ª/g, 'o');
        romaji = romaji.replace(/ã‚«/g, 'ka').replace(/ã‚­/g, 'ki').replace(/ã‚¯/g, 'ku').replace(/ã‚±/g, 'ke').replace(/ã‚³/g, 'ko');
        romaji = romaji.replace(/ã‚µ/g, 'sa').replace(/ã‚·/g, 'shi').replace(/ã‚¹/g, 'su').replace(/ã‚»/g, 'se').replace(/ã‚½/g, 'so');
        romaji = romaji.replace(/ã‚¿/g, 'ta').replace(/ãƒ/g, 'chi').replace(/ãƒ„/g, 'tsu').replace(/ãƒ†/g, 'te').replace(/ãƒˆ/g, 'to');
        romaji = romaji.replace(/ãƒŠ/g, 'na').replace(/ãƒ‹/g, 'ni').replace(/ãƒŒ/g, 'nu').replace(/ãƒ/g, 'ne').replace(/ãƒŽ/g, 'no');
        romaji = romaji.replace(/ãƒ/g, 'ha').replace(/ãƒ’/g, 'hi').replace(/ãƒ•/g, 'fu').replace(/ãƒ˜/g, 'he').replace(/ãƒ›/g, 'ho');
        romaji = romaji.replace(/ãƒž/g, 'ma').replace(/ãƒŸ/g, 'mi').replace(/ãƒ /g, 'mu').replace(/ãƒ¡/g, 'me').replace(/ãƒ¢/g, 'mo');
        romaji = romaji.replace(/ãƒ¤/g, 'ya').replace(/ãƒ¦/g, 'yu').replace(/ãƒ¨/g, 'yo');
        romaji = romaji.replace(/ãƒ©/g, 'ra').replace(/ãƒª/g, 'ri').replace(/ãƒ«/g, 'ru').replace(/ãƒ¬/g, 're').replace(/ãƒ­/g, 'ro');
        romaji = romaji.replace(/ãƒ¯/g, 'wa').replace(/ãƒ²/g, 'wo').replace(/ãƒ³/g, 'n');

        // Long vowels (e.g., ãŠã† -> ou or oo) - simplified to just doubling the vowel for now
        romaji = romaji.replace(/aa/g, 'Ä').replace(/ii/g, 'Ä«').replace(/uu/g, 'Å«').replace(/ee/g, 'Ä“').replace(/oo/g, 'Å');
        romaji = romaji.replace(/ou/g, 'Å'); // Common long 'o' sound

        return romaji;
    }

    function checkVoiceSupport() {
        if ('speechSynthesis' in window) {
            synthesizer = window.speechSynthesis;
            const setVoice = () => {
                japaneseVoice = synthesizer.getVoices().find(voice => voice.lang === 'ja-JP');
                const speechButtons = document.querySelectorAll('.speech-button');
                if (japaneseVoice) {
                    speechButtons.forEach(btn => btn.disabled = false);
                } else {
                    speechButtons.forEach(btn => btn.disabled = true);
                }
            };
            if (synthesizer.getVoices().length) setVoice();
            else synthesizer.onvoiceschanged = setVoice;
        } else {
            document.querySelectorAll('.speech-button').forEach(btn => btn.disabled = true);
        }
    }

    async function fetchJsonFile(filePath, isCritical = false) {
      try {
        const response = await fetch(filePath);
        if (!response.ok) {
          let errorDetail = `HTTP error! Status: ${response.status} for ${filePath}.`;
          if (response.status === 0 || response.type === 'opaque' || response.type === 'error') {
            errorDetail = `Failed to fetch '${filePath}'. This is a common issue due to local file access restrictions (CORS). Please use a local web server.`;
          }
          throw new Error(errorDetail);
        }
        return await response.json();
      } catch (error) {
        console.error("Error fetching JSON:", error.message);
        const displayErrorMessage = error.message;
        if (isCritical) {
            infoBoxArea.innerHTML = `<div class="info-box error-message"><b>Critical Setup Error:</b> ${displayErrorMessage}</div>`;
            kanjiListContainer.innerHTML = `<div class="loader error-message">Cannot initialize. ${displayErrorMessage}</div>`;
        } else if (filePath === `data/${currentFilter}.json`) {
            kanjiListContainer.innerHTML = `<div class="loader error-message">Failed to load data for current filter: ${filePath}.<br>${displayErrorMessage}</div>`;
        }
        return {};
      }
    }

    async function fetchKanjiDataForLevel(level) {
      const fileName = `data/${level}.json`;
      if (level === "learned") {
        if (!allKanjiData || Object.keys(allKanjiData).length === 0) {
          console.warn("'allKanjiData' is empty for 'learned' filter. 'data/all_kanji.json' likely failed to load.");
        }
        return allKanjiData; // Uses pre-loaded allKanjiData
      }
      return await fetchJsonFile(fileName);
    }

    async function loadAndDisplayKanji(level) {
      currentFilter = level;
      currentPage = 1;
      kanjiListContainer.innerHTML = `<div class="loader">Loading ${level.replace(/_/g, " ").toUpperCase()} Kanji...</div>`;
      paginationControlsEl.innerHTML = '';

      filterButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.level === level));
      
      const learnedButton = document.querySelector('button[data-level="learned"]');
      if (level === "learned" && (!allKanjiData || Object.keys(allKanjiData).length === 0)) {
          kanjiListContainer.innerHTML = `<div class="loader error-message">'Learned' filter cannot function because 'data/all_kanji.json' (required for this filter) failed to load or is empty.</div>`;
          currentViewCountEl.textContent = "Displaying: 0 Kanji";
          if (learnedButton) learnedButton.disabled = true;
          updateJLPTCounts();
          return;
      }
      if (learnedButton && allKanjiData && Object.keys(allKanjiData).length > 0) {
          learnedButton.disabled = false;
      }

      currentKanjiData = await fetchKanjiDataForLevel(level);
      updateJLPTCounts();
      renderKanji(); // Call renderKanji which will now respect the search query
    }

    function renderKanji() {
      const fragment = document.createDocumentFragment();
      let itemsToDisplay = [];
      const sourceData = (currentFilter === "learned") ? allKanjiData : currentKanjiData;
      const searchQuery = searchInput.value.toLowerCase().trim();

      if (!sourceData || Object.keys(sourceData).length === 0) {
        if (!kanjiListContainer.querySelector('.error-message')) {
             kanjiListContainer.innerHTML = `<div class="loader">No Kanji data found for "${currentFilter}".</div>`;
        }
        currentViewCountEl.textContent = "Displaying: 0 Kanji";
        paginationControlsEl.innerHTML = '';
        return;
      }

      if (currentFilter === "learned") {
        itemsToDisplay = Object.entries(sourceData).filter(([char]) => learnedKanji.includes(char));
      } else {
        itemsToDisplay = Object.entries(sourceData);
      }

      // --- NEW: Enhanced Search Filtering Logic including Romaji ---
      if (searchQuery) {
          itemsToDisplay = itemsToDisplay.filter(([char, info]) => {
              const meanings = (info.meanings || []).join(' ').toLowerCase();
              const readings_on = (info.readings_on || []).join(' ').toLowerCase();
              const readings_kun = (info.readings_kun || []).join(' ').toLowerCase();
              
              // Convert readings to Romaji for search
              const readings_on_romaji = toRomaji(readings_on);
              const readings_kun_romaji = toRomaji(readings_kun);

              return char.includes(searchQuery) || 
                     meanings.includes(searchQuery) ||
                     readings_on.includes(searchQuery) ||
                     readings_kun.includes(searchQuery) ||
                     readings_on_romaji.includes(searchQuery) || // Search by Romaji On'yomi
                     readings_kun_romaji.includes(searchQuery);  // Search by Romaji Kun'yomi
          });
      }
      // --- End of Enhanced Search Logic ---

      if (itemsToDisplay.length === 0) {
        kanjiListContainer.innerHTML = `<div class="loader">No Kanji characters match the filter: "${currentFilter}" ${searchQuery ? `and search: "${searchQuery}"` : ''}.</div>`;
        currentViewCountEl.textContent = "Displaying: 0 Kanji";
        paginationControlsEl.innerHTML = '';
        return;
      }

      const totalItemsInCurrentFilter = itemsToDisplay.length;
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedItems = itemsToDisplay.slice(startIndex, endIndex);

      currentViewCountEl.textContent = `Displaying ${paginatedItems.length} of ${totalItemsInCurrentFilter} Kanji (Page ${currentPage})`;

      paginatedItems.forEach(([char, info]) => {
        const card = document.createElement("div");
        card.className = "kanji-card";
        card.dataset.char = char;

        const isLearned = learnedKanji.includes(char);
        const meanings = info && info.meanings ? info.meanings.join(', ') : 'N/A';
        const readings_on = info && info.readings_on ? info.readings_on.join(', ') : 'N/A';
        const readings_kun = info && info.readings_kun ? info.readings_kun.join(', ') : 'N/A';
        const strokes = info && info.strokes || 'N/A';
        const grade = info && info.grade || 'N/A';
        const jlptLevel = info && (info.jlpt_new || info.jlpt_old);
        const jlptDisplay = jlptLevel ? `N${jlptLevel}` : 'N/A';
        const wk_level_html = info && info.wk_level ? `<div><span class="field-label">WK Level:</span> ${info.wk_level}</div>` : '';

        // --- NEW: Romaji for readings ---
        const readings_on_romaji = toRomaji(readings_on);
        const readings_kun_romaji = toRomaji(readings_kun);

        card.innerHTML = `
          <div class="kanji-char">
            ${char}
            <button class="speech-button" data-char="${char}" ${!japaneseVoice ? 'disabled' : ''}>ðŸ”Š</button>
          </div>
          <div class="kanji-details">
            <div><span class="field-label">Meanings:</span> ${meanings}</div>
            <div>
                <span class="field-label">On:</span> ${readings_on}
                ${readings_on_romaji ? `<span class="romaji">(${readings_on_romaji})</span>` : ''}
            </div>
            <div>
                <span class="field-label">Kun:</span> ${readings_kun}
                ${readings_kun_romaji ? `<span class="romaji">(${readings_kun_romaji})</span>` : ''}
            </div>
            <div><span class="field-label">Strokes:</span> ${strokes}</div>
            <div><span class="field-label">Grade:</span> ${grade}</div>
            <div><span class="field-label">JLPT:</span> ${jlptDisplay}</div>
            ${wk_level_html}
          </div>
          <button class="learned-btn ${isLearned ? 'is-learned' : ''}" data-char="${char}">
            ${isLearned ? 'Mark as Unlearned' : 'Mark as Learned'}
          </button>
        `;
        fragment.appendChild(card);
      });

      kanjiListContainer.innerHTML = '';
      kanjiListContainer.appendChild(fragment);
      renderPaginationControls(totalItemsInCurrentFilter);
      attachLearnedButtonListeners();
      attachSpeechButtonListeners();
      checkVoiceSupport();
    }

    function attachLearnedButtonListeners() {
      document.querySelectorAll(".learned-btn").forEach(btn => {
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
        newBtn.addEventListener("click", (e) => {
          if (e.target.disabled) return;
          const char = e.target.dataset.char;
          const index = learnedKanji.indexOf(char);
          if (index === -1) {
            learnedKanji.push(char);
          } else {
            learnedKanji.splice(index, 1);
          }
          localStorage.setItem("learnedKanji", JSON.stringify(learnedKanji));
          newBtn.classList.toggle("is-learned", index === -1);
          newBtn.textContent = (index === -1) ? "Mark as Unlearned" : "Mark as Learned";
          if (currentFilter === "learned") {
            currentPage = 1;
            renderKanji();
          }
          updateJLPTCounts();
        });
      });
    }

    function attachSpeechButtonListeners() {
        document.querySelectorAll(".speech-button").forEach(btn => {
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            newBtn.addEventListener("click", (e) => {
                if (!japaneseVoice || !synthesizer || e.target.disabled) return;
                const charToSpeak = e.target.dataset.char;
                speakKanji(charToSpeak);
            });
        });
    }

    function speakKanji(kanjiChar) {
        if (!japaneseVoice || !synthesizer) return;
        if (synthesizer.speaking) synthesizer.cancel();
        const utterance = new SpeechSynthesisUtterance(kanjiChar);
        utterance.lang = 'ja-JP';
        utterance.voice = japaneseVoice;
        utterance.rate = 0.8;
        utterance.pitch = 1;
        synthesizer.speak(utterance);
    }

    function renderPaginationControls(totalItems) {
      paginationControlsEl.innerHTML = '';
      const totalPages = Math.ceil(totalItems / itemsPerPage);
      if (totalPages <= 1) return;
      if (currentPage > 1) {
        const prevButton = document.createElement('button');
        prevButton.textContent = 'Previous';
        prevButton.addEventListener('click', () => { currentPage--; renderKanji(); });
        paginationControlsEl.appendChild(prevButton);
      }
      const pageInfo = document.createElement('span');
      pageInfo.textContent = ` Page ${currentPage} of ${totalPages} `;
      pageInfo.style.margin = "0 10px";
      paginationControlsEl.appendChild(pageInfo);
      if (currentPage < totalPages) {
        const nextButton = document.createElement('button');
        nextButton.textContent = 'Next';
        nextButton.addEventListener('click', () => { currentPage++; renderKanji(); });
        paginationControlsEl.appendChild(nextButton);
      }
    }

    function updateJLPTCounts() {
      const dataForCounting = allKanjiData;
      const counts = { n1: 0, n2: 0, n3: 0, n4: 0, n5: 0, other: 0 };
      let totalInDataset = 0;
      const currentLearnedCount = learnedKanji.length;

      if (dataForCounting && Object.keys(dataForCounting).length > 0) {
        for (const char in dataForCounting) {
          if (dataForCounting.hasOwnProperty(char)) {
            totalInDataset++;
            const info = dataForCounting[char];
            const jlptLevel = info.jlpt_new || info.jlpt_old;
            if (jlptLevel === 1) counts.n1++;
            else if (jlptLevel === 2) counts.n2++;
            else if (jlptLevel === 3) counts.n3++;
            else if (jlptLevel === 4) counts.n4++;
            else if (jlptLevel === 5) counts.n5++;
            else counts.other++;
          }
        }
        jlptCountsEl.innerHTML = `Total (All Data): ${totalInDataset} | N5: ${counts.n5} | N4: ${counts.n4} | N3: ${counts.n3} | N2: ${counts.n2} | N1: ${counts.n1} | Other: ${counts.other} | Learned: <span id="learned-count">${currentLearnedCount}</span>`;
      } else {
        jlptCountsEl.innerHTML = `<span class="error-message">Global counts unavailable ('data/all_kanji.json' missing/empty).</span> Learned: <span id="learned-count">${currentLearnedCount}</span>`;
      }
      const learnedCountEl = document.getElementById('learned-count');
      if(learnedCountEl) learnedCountEl.textContent = currentLearnedCount;
    }

    document.addEventListener('DOMContentLoaded', async () => {
      infoBoxArea.innerHTML = `<div class="info-box"><strong>Tip:</strong> If Kanji don't load, check the browser console (F12) for errors. You might need to use a local web server (see script comments).</div>`;
      checkVoiceSupport();

      filterButtons.forEach(btn => {
        btn.addEventListener('click', (e) => {
          const levelToLoad = e.target.dataset.level;
          if (e.target.disabled) return;
          loadAndDisplayKanji(levelToLoad);
        });
      });
      
      // --- NEW: Search Input Event Listener ---
      let searchTimeout;
      searchInput.addEventListener('input', () => {
          clearTimeout(searchTimeout);
          // Debounce the search to avoid re-rendering on every keystroke
          searchTimeout = setTimeout(() => {
              currentPage = 1; // Reset to first page on new search
              renderKanji();
          }, 250);
      });

      allKanjiData = await fetchJsonFile('data/all_kanji.json', true);

      const learnedButton = document.querySelector('button[data-level="learned"]');
      if (!allKanjiData || Object.keys(allKanjiData).length === 0) {
        if (learnedButton) learnedButton.disabled = true;
      } else {
        if (learnedButton) learnedButton.disabled = false;
      }
      
      updateJLPTCounts();
      
      // Load the default "All" filter on startup
      await loadAndDisplayKanji("all");
    });
    // --- End of Script ---
    </script>
</body>
</html>
